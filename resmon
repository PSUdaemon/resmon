#!/usr/bin/perl

push @INC, '/opt/resmon';

use strict;
use Time::HiRes qw( gettimeofday tv_interval sleep );
use POSIX qw( setsid );
use vars qw($opt_c $opt_d $opt_f $list);

require 'getopts.pl';
require 'resmon_conf.pl';
require 'resmon_code.pl';

Getopts('c:df:');

$opt_c ||= 'resmon.conf';
die "Cannot open configuration file: $opt_c" unless (-r $opt_c);

sub configure {
  $list = parse_config($opt_c);
  set_statusfile($opt_f) if($opt_f);
}
unless($opt_d) {
  fork && exit;
  setsid;
}
configure();
$SIG{'HUP'} = \&configure;
while(1) {
  foreach my $monobj (@$list) {
    my $coderef = fetch_monitor($monobj->{'type'});
    unless($coderef) {
      $coderef = fetch_monitor($monobj->{'type'});
    }
    if($coderef) {
      print_statusfile($monobj->{'object'}."(".$monobj->{'type'}
			.") :: ".$coderef->($monobj)."\n");
    } else {
      print_statusfile($monobj->{'object'}."(".$monobj->{'type'}
			.") :: BAD(no monitor available)\n");
    }
  }
  close_statusfile();
  wait_interval();
  print "\n---- ".localtime(time)."----------\n"
    unless open_statusfile();
}

